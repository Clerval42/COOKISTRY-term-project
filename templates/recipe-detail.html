<!DOCTYPE html>
<html lang="en">
<style>
    .modern-reviews-section {
        background: #fff;
        border-radius: 18px;
        border: 2.5px solid #c0392b;
        box-shadow: 0 6px 32px rgba(192, 57, 43, 0.13), 0 1.5px 8px rgba(0, 0, 0, 0.04);
        padding: 38px 32px 32px 32px;
        margin-top: 48px;
        margin-bottom: 0;
        max-width: 700px;
        margin-left: auto;
        margin-right: auto;
    }

    .modern-reviews-list h4 {
        color: #b71c1c;
        font-size: 19px;
        font-weight: 700;
        margin-bottom: 18px;
    }

    .modern-review-item {
        background: #f9f6f6;
        border-radius: 10px;
        border: 1.5px solid #f2dede;
        box-shadow: 0 2px 10px rgba(192, 57, 43, 0.06);
        padding: 20px 22px 14px 22px;
        margin-bottom: 20px;
        transition: box-shadow 0.2s;
    }

    .modern-review-item:hover {
        box-shadow: 0 6px 24px rgba(192, 57, 43, 0.13);
    }

    .modern-review-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
    }

    .modern-reviewer-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .modern-reviewer-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        object-fit: cover;
        border: 2.5px solid #fff;
        background: #f5f5f5;
    }

    .modern-reviewer-name {
        font-weight: 700;
        color: #b71c1c;
        font-size: 17px;
    }

    .modern-review-rating {
        display: flex;
        align-items: center;
        gap: 2px;
        font-size: 20px;
        color: #c0392b;
    }

    .modern-review-rating .fa-star.fas {
        color: #c0392b;
    }

    .modern-review-rating .fa-star.far {
        color: #ccc;
    }

    .modern-rating-date {
        font-size: 13px;
        color: #888;
        margin-left: 10px;
    }

    .modern-review-comment {
        font-size: 16px;
        color: #444;
        margin-bottom: 4px;
        margin-top: 0;
    }

    .modern-your-review-label {
        font-size: 13px;
        color: #b71c1c;
        font-weight: 600;
        margin-left: 8px;
    }

    .modern-no-reviews {
        color: #b71c1c;
        font-size: 16px;
        text-align: center;
        margin: 18px 0 0 0;
    }

    .modern-review-form-wrapper {
        background: #fff;
        border-radius: 14px;
        border: 2.5px solid #c0392b;
        box-shadow: 0 2px 16px rgba(192, 57, 43, 0.10);
        padding: 32px 24px 20px 24px;
        margin-top: 32px;
        max-width: 520px;
        margin-left: auto;
        margin-right: auto;
        display: flex;
        flex-direction: column;
        align-items: stretch;
    }

    .modern-styled-review-form h4 {
        margin-top: 0;
        color: #c0392b;
        font-size: 22px;
        font-weight: 800;
    }

    .modern-styled-review-form label {
        font-size: 16px;
        color: #b71c1c;
        font-weight: 600;
        margin-top: 12px;
        margin-bottom: 6px;
        display: block;
    }

    .modern-styled-textarea {
        width: 100%;
        min-height: 70px;
        border-radius: 8px;
        border: 2px solid #c0392b;
        padding: 12px 16px;
        font-size: 16px;
        margin-bottom: 14px;
        margin-top: 4px;
        resize: vertical;
        background: #fff;
        color: #333;
        box-sizing: border-box;
    }

    .modern-styled-review-btn {
        background: linear-gradient(90deg, #c0392b 80%, #a5281b 100%);
        color: #fff;
        border: none;
        border-radius: 24px;
        padding: 12px 0;
        font-size: 17px;
        font-weight: 800;
        cursor: pointer;
        width: 100%;
        margin-top: 10px;
        transition: background 0.2s, box-shadow 0.2s;
        box-shadow: 0 2px 8px rgba(192, 57, 43, 0.10);
    }

    .modern-styled-review-btn:hover {
        background: linear-gradient(90deg, #a5281b 80%, #c0392b 100%);
        box-shadow: 0 4px 16px rgba(192, 57, 43, 0.16);
    }

    .modern-star-rating-input {
        display: flex;
        flex-direction: row-reverse;
        justify-content: flex-start;
        gap: 2px;
        margin-bottom: 12px;
    }

    .modern-star-rating-input input[type="radio"] {
        display: none;
    }

    .modern-star-rating-input label {
        font-size: 36px;
        color: #ccc;
        cursor: pointer;
        transition: color 0.2s;
        margin: 0 3px;
        padding: 0;
    }

    .modern-star-rating-input input[type="radio"]:checked~label,
    .modern-star-rating-input label:hover,
    .modern-star-rating-input label:hover~label {
        color: #c0392b;
    }

    .modern-login-to-review {
        color: #b71c1c;
        font-size: 16px;
        text-align: center;
        margin-top: 32px;
    }

    @media (max-width: 700px) {
        .modern-reviews-section {
            padding: 16px 2vw 16px 2vw;
            max-width: 99vw;
        }

        .modern-review-form-wrapper {
            padding: 14px 2vw 14px 2vw;
        }
    }
</style>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COOKISTRY - {{ recipe.RecipeName }}</title>
    <link rel="stylesheet" href="static\css\style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>

<body>
    {% extends 'base.html' %}
    {% block title %}COOKISTRY - {{ recipe.RecipeName }}{% endblock %}
    {% block content %}
    <main class="recipe-detail-page">
        <article class="recipe-content-wrapper">
            <!-- Tarif Başlığı ve Fotoğrafı -->
            <section class="recipe-hero">
                <div class="recipe-image-container">
                    <img src="{{ url_for('static', filename=recipe.RecipeImagePath) }}" alt="{{ recipe.RecipeName }}"
                        class="recipe-main-image">
                    <h1 class="recipe-title-overlay">{{ recipe.RecipeName }}</h1>
                </div>
            </section>

            <!-- Yazar ve Tarif Bilgileri -->
            <section class="recipe-meta-info">
                <div class="author-info">
                    <a href="{{ url_for('profile.user_profile', id=recipe.user.UserID) }}">
                        <img src="{{ url_for('static', filename=recipe.user.ProfilePicturePath) }}"
                            alt="{{ recipe.user.UserName }}" class="author-avatar">
                        <span class="author-name">{{ recipe.user.UserName }}</span>
                    </a>
                </div>
                <div class="publish-date">
                    <i class="fas fa-calendar-alt"></i> Published: {{ recipe.RecipeDate.strftime('%B %d, %Y') }}
                </div>
                <div class="recipe-quick-stats">
                    <span><i class="fas fa-tag"></i> Category: {{ recipe.RecipeCategory }}</span>
                    <span><i class="far fa-clock"></i> Cook: {{ recipe.CookingTime }} mins</span>
                    <span><i class="fas fa-users"></i> Servings: {{ recipe.Servings }}</span>
                </div>
            </section>

            <div class="recipe-details-grid">
                <section class="recipe-description-section">
                    <h2><i class="fas fa-info-circle"></i> Description</h2>
                    <p>{{ recipe.Description }}</p>
                </section>
                <section class="recipe-ingredients-section">
                    <h2><i class="fas fa-shopping-basket"></i> Ingredients</h2>
                    <ul class="ingredients-list">
                        {% for ri in recipe.ingredients %}
                        <li><span class="qty">{{ ri.Quantity }} {{ ri.Unit }}</span> {{ ri.ingredient.IngredientName }}
                        </li>
                        {% endfor %}
                    </ul>
                </section>
            </div>

            <section class="recipe-instructions-section">
                <h2><i class="fas fa-utensils"></i> Instructions</h2>
                <ol class="instructions-list">
                    {% for step in recipe.instructions|sort(attribute='StepNumber') %}
                    <li>
                        <span class="instruction-step-number">{{ step.StepNumber }}.</span>
                        <div class="instruction-text">{{ step.InstructionText }}</div>
                        {% if step.ImagePath %}
                        <img src="{{ url_for('static', filename=step.ImagePath) }}" alt="Step {{ step.StepNumber }}"
                            class="instruction-step-image">
                        {% endif %}
                    </li>
                    {% endfor %}
                </ol>
            </section>

            <!-- Puanlama ve Yorumlar Bölümü -->
            <section class="recipe-reviews-section modern-reviews-section">
                <h2><i class="fas fa-star-half-alt"></i> Ratings & Reviews</h2>
                <div class="current-rating-summary">
                    {% set avg = recipe.reviews|map(attribute='Score')|list %}
                    <span class="average-rating">{{ avg|length and (avg|sum / avg|length)|round(1) or 'N/A' }} <i
                            class="fas fa-star"></i></span>
                    <span class="total-reviews">(Based on {{ avg|length }} Reviews)</span>
                </div>
                {% set user_review = None %}
                {% if session['user_id'] %}
                {% for review in recipe.reviews %}
                {% if review.UserID == session['user_id'] and not user_review %}
                {% set user_review = review %}
                {% endif %}
                {% endfor %}
                {% endif %}
                <div class="existing-reviews-list modern-reviews-list">
                    <h4>What Others Are Saying:</h4>
                    {% for review in recipe.reviews %}
                    <div class="review-item modern-review-item">
                        <div class="review-item-header modern-review-header">
                            <div class="reviewer-info modern-reviewer-info">
                                <img src="{{ url_for('static', filename=review.user.ProfilePicturePath) }}"
                                    alt="{{ review.user.UserName }}" class="reviewer-avatar modern-reviewer-avatar">
                                <span class="reviewer-name modern-reviewer-name">{{ review.user.UserName }}</span>
                            </div>
                            <div class="review-rating modern-review-rating">
                                {% for i in range(1, 6) %}
                                <i class="fa-star {% if review.Score >= i %}fas{% else %}far{% endif %}"></i>
                                {% endfor %}
                                <span class="rating-date modern-rating-date">({{ review.ReviewDate.strftime('%B %d, %Y')
                                    }})</span>
                            </div>
                        </div>
                        <p class="review-comment modern-review-comment">{{ review.Comment }}</p>
                        {% if session['user_id'] and review.UserID == session['user_id'] %}
                        <span class="your-review-label modern-your-review-label">(Your Review)</span>
                        {% endif %}
                        {% if logged_in_user_type == 'Admin' or review.UserID == session['user_id'] %}
                        <form method="POST"
                            action="{{ url_for('recipe.delete_recipe_review', review_id=review.ReviewID) }}"
                            style="display:inline;"
                            onsubmit="return confirm('Are you sure you want to delete this review?');">
                            <button type="submit" class="delete-btn">Delete</button>
                        </form>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% if recipe.reviews|length == 0 %}
                    <p class="modern-no-reviews">No reviews yet.</p>
                    {% endif %}
                </div>
                {% if session['user_id'] %}
                <div class="review-form-wrapper modern-review-form-wrapper">
                    {% if not user_review %}
                    <form class="review-form styled-review-form modern-styled-review-form" method="POST"
                        action="{{ url_for('recipe.add_recipe_review', recipe_id=recipe.RecipeID) }}">
                        <h4>Leave a Review</h4>
                        <div class="star-rating-input modern-star-rating-input" id="starRatingInput">
                            {% for i in range(5, 0, -1) %}
                            <input type="radio" id="star{{ i }}" name="score" value="{{ i }}" required>
                            <label for="star{{ i }}" title="{{ i }} stars"><i class="fas fa-star"></i></label>
                            {% endfor %}
                        </div>
                        <label for="comment">Comment:</label>
                        <textarea name="comment" id="comment" rows="2" required placeholder="Share your thoughts..."
                            class="styled-textarea modern-styled-textarea"></textarea>
                        <button type="submit" class="styled-review-btn modern-styled-review-btn">Submit Review</button>
                    </form>
                    {% else %}
                    <form class="review-form styled-review-form modern-styled-review-form" method="POST"
                        action="{{ url_for('recipe.edit_recipe_review', recipe_id=recipe.RecipeID) }}">
                        <h4>Edit Your Review</h4>
                        <div class="star-rating-input modern-star-rating-input" id="starRatingInput">
                            {% for i in range(5, 0, -1) %}
                            <input type="radio" id="star-edit-{{ i }}" name="score" value="{{ i }}" {% if
                                user_review.Score==i %}checked{% endif %} required>
                            <label for="star-edit-{{ i }}" title="{{ i }} stars"><i class="fas fa-star"></i></label>
                            {% endfor %}
                        </div>
                        <label for="comment">Comment:</label>
                        <textarea name="comment" id="comment" rows="2" required
                            class="styled-textarea modern-styled-textarea">{{ user_review.Comment }}</textarea>
                        <button type="submit" class="styled-review-btn modern-styled-review-btn">Update Review</button>
                    </form>
                    {% endif %}
                </div>
                {% else %}
                <p class="login-to-review modern-login-to-review">You must <a
                        href="{{ url_for('auth.login', next=request.url) }}">log in</a> to leave a review.</p>
                {% endif %}
            </section>
        </article>
    </main>
    {% endblock %}
    <script src="static\js\script.js"></script>
</body>

</html>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.modern-star-rating-input').forEach(function (starInput) {
            starInput.querySelectorAll('label').forEach(function (label) {
                label.addEventListener('click', function (e) {
                    var input = document.getElementById(label.getAttribute('for'));
                    if (input) input.checked = true;
                });
            });
        });
    });
</script>